<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA Daily Stats ‚Äî Hoopsmatic</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#0a0e17;--bg-secondary:#111827;--bg-card:#151d2e;--bg-row-hover:#1a2540;--border:#1e2d4a;--text-primary:#e8ecf4;--text-secondary:#8892a6;--text-muted:#555f73;--accent-gold:#f0b637;--accent-blue:#3b82f6;--accent-cyan:#22d3ee;--positive:#10b981;--negative:#ef4444;--orange:#f97316}
*{margin:0;padding:0;box-sizing:border-box}body{background:var(--bg-primary);color:var(--text-primary);font-family:'Source Sans 3',sans-serif;min-height:100vh;line-height:1.5}
.header{background:linear-gradient(135deg,#0d1321 0%,#172040 50%,#0d1321 100%);border-bottom:1px solid var(--border);padding:2rem 2rem 1.5rem;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(90deg,transparent,transparent 60px,rgba(59,130,246,0.03) 60px,rgba(59,130,246,0.03) 61px);pointer-events:none}
.header-inner{max-width:1400px;margin:0 auto;position:relative;z-index:1;display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:1rem}
.header-brand{display:flex;align-items:baseline;gap:0.75rem;margin-bottom:0.25rem}
.header-brand h1{font-family:'Oswald',sans-serif;font-weight:700;font-size:2rem;letter-spacing:0.05em;text-transform:uppercase}
.header-brand .tag{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--accent-gold);background:rgba(240,182,55,0.12);padding:0.2em 0.6em;border-radius:3px;letter-spacing:0.08em;text-transform:uppercase}
.header-subtitle{color:var(--text-secondary);font-size:0.95rem}
.date-controls{display:flex;align-items:center;gap:0.75rem}
.date-controls input[type="date"]{font-family:'JetBrains Mono',monospace;font-size:0.9rem;padding:0.55rem 0.85rem;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);outline:none;color-scheme:dark;cursor:pointer}
.btn-fetch{font-family:'Oswald',sans-serif;font-size:0.95rem;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;padding:0.55rem 1.5rem;border:none;border-radius:6px;background:var(--accent-blue);color:#fff;cursor:pointer;transition:all 0.2s}
.btn-fetch:hover{background:#2563eb;transform:translateY(-1px)}.btn-fetch:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.btn-prev,.btn-next{font-size:1.1rem;padding:0.45rem 0.7rem;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);cursor:pointer;transition:all 0.15s}
.btn-prev:hover,.btn-next:hover{border-color:var(--accent-blue);color:var(--text-primary)}
.summary-bar{max-width:1400px;margin:1.25rem auto 0;padding:0 2rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:0.75rem}
.stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:1rem 1.15rem}
.stat-card .label{font-family:'JetBrains Mono',monospace;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-muted);margin-bottom:0.2rem}
.stat-card .value{font-family:'Oswald',sans-serif;font-size:1.4rem;font-weight:600}
.stat-card .sub{font-size:0.78rem;color:var(--text-secondary);margin-top:0.15rem}
.games-section{max-width:1400px;margin:1.5rem auto 0;padding:0 2rem}
.games-section h2{font-family:'Oswald',sans-serif;font-size:1.15rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-secondary);margin-bottom:0.75rem}
.games-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:0.75rem}
.game-card{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:1rem;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.game-card:hover{border-color:var(--accent-blue);transform:translateY(-2px);box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.game-card .status-badge{font-family:'JetBrains Mono',monospace;font-size:0.6rem;text-transform:uppercase;letter-spacing:0.08em;padding:0.15em 0.5em;border-radius:3px;position:absolute;top:0.65rem;right:0.65rem}
.game-card .status-badge.final{background:rgba(16,185,129,0.15);color:var(--positive)}
.game-card .status-badge.live{background:rgba(239,68,68,0.2);color:var(--negative);animation:pulse 2s infinite}
.game-card .status-badge.upcoming{background:rgba(136,146,166,0.15);color:var(--text-secondary)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
.game-card .team-row{display:flex;align-items:center;gap:0.6rem;padding:0.3rem 0}
.game-card .team-row img{width:28px;height:28px;object-fit:contain}
.game-card .team-row .team-name{font-family:'Oswald',sans-serif;font-size:0.95rem;font-weight:500;flex:1}
.game-card .team-row .score{font-family:'Oswald',sans-serif;font-size:1.15rem;font-weight:700;min-width:36px;text-align:right}
.game-card .team-row .score.winner{color:var(--accent-gold)}
.game-card .vs-divider{border:none;border-top:1px solid var(--border);margin:0.15rem 0}

/* Mode tabs */
.mode-tabs{display:flex;gap:2px;background:var(--bg-secondary);border-radius:6px;padding:2px;margin-right:auto}
.mode-tab{font-family:'JetBrains Mono',monospace;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.06em;padding:0.4rem 0.85rem;border:none;border-radius:4px;background:transparent;color:var(--text-muted);cursor:pointer;transition:all 0.15s;white-space:nowrap}
.mode-tab:hover{color:var(--text-secondary)}
.mode-tab.active{background:var(--accent-blue);color:#fff}
.mode-tab .badge{display:inline-block;width:6px;height:6px;border-radius:50%;margin-left:4px;vertical-align:middle}
.mode-tab .badge.ok{background:var(--positive)}.mode-tab .badge.fail{background:var(--negative)}.mode-tab .badge.loading{background:var(--accent-gold);animation:pulse 1s infinite}

.rankings-section{max-width:1400px;margin:1.75rem auto 3rem;padding:0 2rem}
.rankings-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:0.75rem;flex-wrap:wrap;gap:0.5rem}
.rankings-header h2{font-family:'Oswald',sans-serif;font-size:1.15rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-secondary);margin-right:1rem}
.rankings-filters{display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap}
.rankings-filters select,.rankings-filters input{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:0.45rem 0.7rem;color:var(--text-primary);font-family:'Source Sans 3',sans-serif;font-size:0.82rem;outline:none}
.rankings-filters input{width:160px}.rankings-filters input::placeholder{color:var(--text-muted)}

.table-wrap{overflow-x:auto;border-radius:8px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;font-size:0.82rem}
thead th{font-family:'JetBrains Mono',monospace;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-muted);padding:0.7rem 0.5rem;background:var(--bg-secondary);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;cursor:pointer;white-space:nowrap;user-select:none}
thead th:hover{color:var(--text-primary)}thead th.sorted{color:var(--accent-gold)}
thead th .arrow{font-size:0.55rem;margin-left:0.2rem}
tbody tr{border-bottom:1px solid rgba(30,45,74,0.4);transition:background 0.12s}
tbody tr:hover{background:var(--bg-row-hover)}tbody td{padding:0.55rem 0.5rem;white-space:nowrap}
td.player-cell{display:flex;align-items:center;gap:0.5rem;min-width:180px}
td.player-cell img{width:32px;height:24px;object-fit:cover;border-radius:3px;background:var(--bg-secondary)}
td.player-cell .pname{font-weight:600;font-size:0.85rem}
td.player-cell .pteam{font-size:0.7rem;color:var(--text-muted);margin-left:0.3rem}
td.num{text-align:right;font-family:'JetBrains Mono',monospace;font-size:0.78rem}
td.rank-cell{font-family:'Oswald',sans-serif;font-weight:600;text-align:center;color:var(--accent-gold)}
td.rat-cell{font-family:'Oswald',sans-serif;font-weight:700;text-align:right;font-size:0.9rem}
td.positive{color:var(--positive)}td.negative{color:var(--negative)}
.top-badge{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:0.55rem;padding:0.1em 0.35em;border-radius:2px;margin-left:0.3rem;font-weight:600}
.top-badge.gold{background:rgba(240,182,55,0.15);color:var(--accent-gold)}
.top-badge.silver{background:rgba(136,146,166,0.15);color:var(--text-secondary)}
.top-badge.bronze{background:rgba(249,115,22,0.15);color:var(--orange)}

.unavailable-msg{text-align:center;padding:2rem;color:var(--text-muted);font-size:0.9rem}
.unavailable-msg span{color:var(--negative);font-weight:600}
.sheet-date-note{text-align:center;padding:0.5rem;color:var(--text-muted);font-family:'JetBrains Mono',monospace;font-size:0.7rem;letter-spacing:0.05em}

/* Box score modal */
.box-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;display:none;align-items:center;justify-content:center;padding:1rem}
.box-overlay.open{display:flex}
.box-modal{background:var(--bg-primary);border:1px solid var(--border);border-radius:10px;max-width:1100px;width:100%;max-height:90vh;overflow-y:auto}
.box-modal-header{display:flex;align-items:center;justify-content:space-between;padding:1.25rem 1.5rem;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-primary);z-index:5}
.box-modal-header h3{font-family:'Oswald',sans-serif;font-size:1.1rem;text-transform:uppercase;letter-spacing:0.04em}
.box-close{background:none;border:none;color:var(--text-secondary);font-size:1.4rem;cursor:pointer;padding:0.25rem 0.5rem}
.box-close:hover{color:var(--text-primary)}
.box-content{padding:1rem 1.5rem 1.5rem}
.box-team-label{font-family:'Oswald',sans-serif;font-size:0.95rem;text-transform:uppercase;letter-spacing:0.04em;color:var(--accent-cyan);margin:1rem 0 0.4rem;display:flex;align-items:center;gap:0.5rem}
.box-team-label:first-child{margin-top:0}.box-team-label img{width:24px;height:24px}
.box-content table{font-size:0.78rem}.box-content thead th{font-size:0.6rem;padding:0.5rem 0.4rem}
.box-content tbody td{padding:0.4rem}.box-content tbody tr.dnp{opacity:0.4}
.box-content .team-totals td{font-weight:700;border-top:2px solid var(--border);background:var(--bg-secondary)}

.empty-state{text-align:center;padding:4rem 2rem;color:var(--text-muted)}
.empty-state .icon{font-size:3rem;margin-bottom:1rem;opacity:0.5}
.empty-state h3{font-family:'Oswald',sans-serif;font-size:1.2rem;color:var(--text-secondary);margin-bottom:0.4rem}
.empty-state p{font-size:0.9rem;max-width:400px;margin:0 auto}
.error-banner{max-width:1400px;margin:1rem auto;padding:0 2rem}
.error-banner .inner{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);border-radius:8px;padding:0.85rem 1.2rem;font-size:0.88rem;color:#fca5a5}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:0.4rem}
@keyframes spin{to{transform:rotate(360deg)}}
.progress-bar{max-width:1400px;margin:1rem auto;padding:0 2rem;display:none}.progress-bar.active{display:block}
.progress-inner{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1.2rem;font-size:0.85rem;color:var(--text-secondary)}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:var(--bg-primary)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@media(max-width:768px){.header-inner{flex-direction:column;align-items:flex-start}.summary-bar{grid-template-columns:repeat(2,1fr)}.games-grid{grid-template-columns:1fr}.mode-tabs{flex-wrap:wrap}}
</style>
</head>
<body>
<div class="header"><div class="header-inner"><div class="header-left"><div class="header-brand"><h1>Daily Stats</h1><span class="tag">Hoopsmatic</span></div><div class="header-subtitle">Box scores, advanced stats & player ratings</div></div><div class="date-controls"><button class="btn-prev" onclick="shiftDate(-1)">‚óÄ</button><input type="date" id="datePicker"><button class="btn-next" onclick="shiftDate(1)">‚ñ∂</button><button class="btn-fetch" id="fetchBtn" onclick="fetchDay()">Fetch Games</button></div></div></div>
<div id="errorArea"></div>
<div class="progress-bar" id="progressBar"><div class="progress-inner"><span id="progressText">Loading...</span><div style="background:var(--border);border-radius:2px;height:3px;margin-top:0.5rem"><div id="progressFill" style="height:3px;background:var(--accent-blue);border-radius:2px;transition:width 0.3s;width:0%"></div></div></div></div>
<div id="summaryArea"></div>
<div id="gamesArea"></div>
<div id="rankingsArea"><div class="empty-state"><div class="icon">üèÄ</div><h3>Select a date to get started</h3><p>Pick a game date and click "Fetch Games" to load box scores, advanced stats, and player ratings.</p></div></div>
<div class="box-overlay" id="boxOverlay" onclick="if(event.target===this)closeBox()"><div class="box-modal"><div class="box-modal-header"><h3 id="boxTitle"></h3><button class="box-close" onclick="closeBox()">‚úï</button></div><div class="box-content" id="boxContent"></div></div></div>

<script>
// ===================== CORS PROXY =====================
const PROXY='https://corsproxy.io/?';
function proxied(url){return PROXY+encodeURIComponent(url)}

// ===================== GOOGLE SHEETS CONFIG =====================
const SHEET_PUB='https://docs.google.com/spreadsheets/d/e/2PACX-1vS2iZj3avZ_-CAWKu-f_pxZkf38M0quXQwMbyTXmHsN6-c9V8vU1l_sNaxg0y8dl07dqraU3_5Z3b8D/pub';
const GID_HUSTLE='1809402386';
const GID_MISC='384588563';
const GID_RAT='295683685';       // Traditional ‚Äî col B=PLAYER_NAME, BV=RAT
const GID_CLUTCH_RAT='197990217'; // Clutch ‚Äî col BW=clutch RAT
const GID_NAMES='1197809522';     // Nomenclature ‚Äî col L=NBA NAME, M=HH NAME
function sheetCSV(gid){return`${SHEET_PUB}?gid=${gid}&single=true&output=csv`}

// Column letter ‚Üí 0-based index (A=0, BV=73, BW=74, L=11, M=12)
function colIdx(letter){
  let n=0;
  for(let i=0;i<letter.length;i++)n=n*26+(letter.charCodeAt(i)-64);
  return n-1;
}
const COL_RAT=colIdx('BV');       // 73
const COL_CLUTCH_RAT=colIdx('BW'); // 74
const COL_NBA_NAME=colIdx('L');    // 11
const COL_HH_NAME=colIdx('M');     // 12
const COL_PLAYER_ID=colIdx('A');   // 0
const COL_PLAYER_NAME=colIdx('B'); // 1

function parseCSV(text){
  // Parse CSV handling quoted fields; skip row 1 (metadata) and row 2 (empty), headers on row 3
  const lines=[];let cur='',inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c==='"'){if(inQ&&text[i+1]==='"'){cur+='"';i++}else inQ=!inQ}
    else if(c===','&&!inQ){lines.length?lines[lines.length-1].push(cur):lines.push([cur]);cur=''}
    else if((c==='\n'||(c==='\r'&&text[i+1]==='\n'))&&!inQ){
      if(c==='\r')i++;
      if(lines.length){lines[lines.length-1].push(cur)}else{lines.push([cur])}
      cur='';lines.push([]);
    }else cur+=c;
  }
  if(cur||lines.length){if(lines.length){lines[lines.length-1].push(cur)}else lines.push([cur])}
  // Row 1=metadata, row 2=empty, row 3=headers, row 4+=data
  if(lines.length<4)return[];
  const hdrs=lines[2];
  const rows=[];
  for(let i=3;i<lines.length;i++){
    if(lines[i].length<2)continue;
    const obj={};hdrs.forEach((h,j)=>obj[h.trim()]=lines[i][j]||'');
    obj._raw=lines[i]; // keep raw array for positional access
    rows.push(obj);
  }
  return rows;
}

// ===================== TEAM INFO =====================
const TEAM_IDS={ATL:1610612737,BOS:1610612738,BKN:1610612751,CHA:1610612766,CHI:1610612741,CLE:1610612739,DAL:1610612742,DEN:1610612743,DET:1610612765,GSW:1610612744,HOU:1610612745,IND:1610612754,LAC:1610612746,LAL:1610612747,MEM:1610612763,MIA:1610612748,MIL:1610612749,MIN:1610612750,NOP:1610612740,NYK:1610612752,OKC:1610612760,ORL:1610612753,PHI:1610612755,PHX:1610612756,POR:1610612757,SAC:1610612758,SAS:1610612759,TOR:1610612761,UTA:1610612762,WAS:1610612764};
const ID_TO_TRI={};for(const[t,id]of Object.entries(TEAM_IDS))ID_TO_TRI[id]=t;
const TEAM_NAMES={ATL:'Atlanta Hawks',BOS:'Boston Celtics',BKN:'Brooklyn Nets',CHA:'Charlotte Hornets',CHI:'Chicago Bulls',CLE:'Cleveland Cavaliers',DAL:'Dallas Mavericks',DEN:'Denver Nuggets',DET:'Detroit Pistons',GSW:'Golden State Warriors',HOU:'Houston Rockets',IND:'Indiana Pacers',LAC:'LA Clippers',LAL:'Los Angeles Lakers',MEM:'Memphis Grizzlies',MIA:'Miami Heat',MIL:'Milwaukee Bucks',MIN:'Minnesota Timberwolves',NOP:'New Orleans Pelicans',NYK:'New York Knicks',OKC:'Oklahoma City Thunder',ORL:'Orlando Magic',PHI:'Philadelphia 76ers',PHX:'Phoenix Suns',POR:'Portland Trail Blazers',SAC:'Sacramento Kings',SAS:'San Antonio Spurs',TOR:'Toronto Raptors',UTA:'Utah Jazz',WAS:'Washington Wizards'};
function teamLogo(t){return`https://cdn.nba.com/logos/nba/${TEAM_IDS[t]||0}/primary/L/logo.svg`}
function headshot(pid){return`https://cdn.nba.com/headshots/nba/latest/260x190/${pid}.png`}

// ===================== STATE =====================
let scheduleCache=null, currentBoxScores=[], allPlayers=[];
let hustleMap={}, clutchMap={}, miscMap={};  // personId ‚Üí stats
let hustleStatus='none', clutchStatus='none', miscStatus='none';
let hustleDate='', miscDate=''; // date from sheet metadata row
let nameMap={};       // NBA name ‚Üí HH name
let sheetRatMap={};   // personId ‚Üí RAT from sheet
let clutchRatMap={};  // personId ‚Üí clutch RAT from sheet
let viewMode='standard'; // standard|advanced|hustle|clutch|misc
let sortCol='rat', sortDir='desc';

// ===================== UTILITIES =====================
function todayPacific(){return new Date().toLocaleDateString('en-CA',{timeZone:'America/Los_Angeles'})}
function shiftDate(d){const p=document.getElementById('datePicker');const dt=new Date(p.value+'T12:00:00');dt.setDate(dt.getDate()+d);p.value=dt.toISOString().slice(0,10)}
function fmtDate(s){return new Date(s+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}
function progress(msg,pct){document.getElementById('progressBar').classList.add('active');document.getElementById('progressText').textContent=msg;document.getElementById('progressFill').style.width=pct+'%'}
function hideProgress(){document.getElementById('progressBar').classList.remove('active')}
function parseMin(s){if(!s||s==='0')return 0;if(typeof s==='number')return s;let m=String(s).match(/PT(\d+)M([\d.]+)S/);if(m)return parseInt(m[1])+parseFloat(m[2])/60;m=String(s).match(/PT(\d+)M/);if(m)return parseInt(m[1]);m=String(s).match(/^(\d+):([\d.]+)$/);if(m)return parseInt(m[1])+parseFloat(m[2])/60;return parseFloat(s)||0}

// ===================== STAT COMPUTATION ‚Äî BASIC =====================
function computeStats(p,teamTri,oppTri,gameId){
  const s=p.statistics;if(!s)return null;
  const min=parseMin(s.minutes||s.minutesCalculated||0);if(min<=0)return null;
  const pts=s.points||0,fgm=s.fieldGoalsMade||0,fga=s.fieldGoalsAttempted||0;
  const fg3m=s.threePointersMade||0,fg3a=s.threePointersAttempted||0;
  const ftm=s.freeThrowsMade||0,fta=s.freeThrowsAttempted||0;
  const orb=s.reboundsOffensive??0,drb=s.reboundsDefensive??0,reb=s.reboundsTotal??(orb+drb);
  const ast=s.assists||0,stl=s.steals||0,blk=s.blocks||0;
  const tov=s.turnovers||0,pf=s.foulsPersonal||0,pm=s.plusMinusPoints??s.plusMinus??0;
  const tsa=fga+0.44*fta;const ts=tsa>0?pts/(2*tsa):0;
  const fgPct=fga>0?fgm/fga:0,fg3Pct=fg3a>0?fg3m/fg3a:0,ftPct=fta>0?ftm/fta:0;
  const efg=fga>0?(fgm+0.5*fg3m)/fga:0;
  const gmScr=pts+0.4*fgm-0.7*fga-0.4*(fta-ftm)+0.7*orb+0.3*drb+stl+0.7*ast+0.7*blk-0.4*pf-tov;
  const tsFactor=Math.min(1.5,Math.max(0.5,tsa>0?ts/0.55:0.7));
  const rat=pts*tsFactor+ast*1.5+reb*1.0+stl*2.5+blk*2.0-tov*2.0+pm*0.25;
  return{personId:p.personId,name:p.name||`${p.firstName||''} ${p.familyName||''}`.trim(),
    team:teamTri,opponent:oppTri,gameId,
    min:Math.round(min*10)/10,pts,fgm,fga,fg3m,fg3a,ftm,fta,orb,drb,reb,ast,stl,blk,tov,pf,pm,
    fgPct,fg3Pct,ftPct,efg,ts,gmScr:Math.round(gmScr*10)/10,rat:Math.round(rat*10)/10,
    // Advanced ‚Äî filled in after team totals computed
    usg:0,astPct:0,tovPct:0,orbPct:0,drbPct:0};
}

// ===================== ADVANCED STATS ‚Äî POST-PROCESS =====================
function computeAdvanced(players){
  // Group by gameId+team to get team totals
  const teamTotals={};
  for(const p of players){
    const key=p.gameId+'_'+p.team;
    if(!teamTotals[key])teamTotals[key]={fga:0,fta:0,tov:0,orb:0,drb:0,min:0};
    const t=teamTotals[key];
    t.fga+=p.fga;t.fta+=p.fta;t.tov+=p.tov;t.orb+=p.orb;t.drb+=p.drb;t.min+=p.min;
  }
  // Get opponent team totals
  const oppTotals={};
  for(const p of players){
    const oppKey=p.gameId+'_'+p.opponent;
    if(teamTotals[oppKey])oppTotals[p.gameId+'_'+p.team]=teamTotals[oppKey];
  }

  for(const p of players){
    const key=p.gameId+'_'+p.team;
    const t=teamTotals[key];const opp=oppTotals[key];
    if(!t||p.min<=0)continue;
    // USG% = 100 * ((FGA + 0.44*FTA + TOV) * (teamMin/5)) / (MIN * (teamFGA + 0.44*teamFTA + teamTOV))
    const teamPoss=t.fga+0.44*t.fta+t.tov;
    p.usg=teamPoss>0?Math.round(1000*((p.fga+0.44*p.fta+p.tov)*(t.min/5))/(p.min*teamPoss))/10:0;
    // AST% = AST / (FGA + 0.44*FTA + AST + TOV) * 100
    const touches=p.fga+0.44*p.fta+p.ast+p.tov;
    p.astPct=touches>0?Math.round(1000*p.ast/touches)/10:0;
    // TOV% = TOV / (FGA + 0.44*FTA + TOV) * 100
    const tovDenom=p.fga+0.44*p.fta+p.tov;
    p.tovPct=tovDenom>0?Math.round(1000*p.tov/tovDenom)/10:0;
    // ORB% and DRB% (need opponent rebound data)
    if(opp){
      const orbChances=p.min>0?(t.orb+opp.drb):0;
      p.orbPct=orbChances>0?Math.round(1000*(p.orb*(t.min/5))/(p.min*orbChances))/10:0;
      const drbChances=p.min>0?(t.drb+opp.orb):0;
      p.drbPct=drbChances>0?Math.round(1000*(p.drb*(t.min/5))/(p.min*drbChances))/10:0;
    }
  }
}

// ===================== HUSTLE STATS ‚Äî from Google Sheet =====================
async function fetchAllHustle(){
  hustleMap={};hustleStatus='loading';updateModeBadges();
  try{
    const res=await fetch(sheetCSV(GID_HUSTLE));
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    const hText=await res.text();
    const hm=hText.match(/Date:\s*(\d{1,2}\/\d{1,2}\/\d{4})/);
    if(hm)hustleDate=hm[1];
    const rows=parseCSV(hText);
    for(const r of rows){
      const pid=parseInt(r.PLAYER_ID);if(!pid)continue;
      hustleMap[pid]={
        name:r.PLAYER_NAME||'',team:r.TEAM_ABBREVIATION||'',
        min:parseFloat(r.MIN)||0,
        deflections:parseInt(r.DEFLECTIONS)||0,
        looseBalls:parseInt(r.LOOSE_BALLS_RECOVERED)||0,
        contested2:parseInt(r.CONTESTED_SHOTS_2PT)||0,
        contested3:parseInt(r.CONTESTED_SHOTS_3PT)||0,
        contestedTotal:parseInt(r.CONTESTED_SHOTS)||0,
        charges:parseInt(r.CHARGES_DRAWN)||0,
        screenAst:parseInt(r.SCREEN_ASSISTS)||0,
        boxOuts:parseInt(r.BOX_OUTS)||0
      };
    }
    hustleStatus=Object.keys(hustleMap).length>0?'ok':'fail';
  }catch(e){console.warn('Hustle:',e.message);hustleStatus='fail'}
  updateModeBadges();
}

// ===================== MISC STATS ‚Äî from Google Sheet =====================
async function fetchAllMisc(){
  miscMap={};miscStatus='loading';updateModeBadges();
  try{
    const res=await fetch(sheetCSV(GID_MISC));
    if(!res.ok)throw new Error(`HTTP ${res.status}`);
    const mText=await res.text();
    const mm=mText.match(/Date:\s*(\d{1,2}\/\d{1,2}\/\d{4})/);
    if(mm)miscDate=mm[1];
    const rows=parseCSV(mText);
    for(const r of rows){
      const pid=parseInt(r.PLAYER_ID);if(!pid)continue;
      miscMap[pid]={
        name:r.PLAYER_NAME||'',team:r.TEAM_ABBREVIATION||'',
        min:parseFloat(r.MIN)||0,
        ptsOffTov:parseInt(r.PTS_OFF_TOV)||0,
        pts2nd:parseInt(r.PTS_2ND_CHANCE)||0,
        ptsFb:parseInt(r.PTS_FB)||0,
        ptsPaint:parseInt(r.PTS_PAINT)||0,
        oppPtsOffTov:parseInt(r.OPP_PTS_OFF_TOV)||0,
        oppPts2nd:parseInt(r.OPP_PTS_2ND_CHANCE)||0,
        oppPtsFb:parseInt(r.OPP_PTS_FB)||0,
        oppPtsPaint:parseInt(r.OPP_PTS_PAINT)||0,
        blka:parseInt(r.BLKA)||0,
        pfd:parseInt(r.PFD)||0
      };
    }
    miscStatus=Object.keys(miscMap).length>0?'ok':'fail';
  }catch(e){console.warn('Misc:',e.message);miscStatus='fail'}
  updateModeBadges();
}

// ===================== SHEET RAT ‚Äî from Traditional Stats sheet =====================
async function fetchSheetRat(){
  sheetRatMap={};
  try{
    const res=await fetch(sheetCSV(GID_RAT));
    if(!res.ok)return;
    const rows=parseCSV(await res.text());
    for(const r of rows){
      const pid=parseInt(r._raw[COL_PLAYER_ID]);if(!pid)continue;
      const rat=parseFloat(r._raw[COL_RAT]);
      if(!isNaN(rat))sheetRatMap[pid]=rat;
    }
    console.log(`Sheet RAT: ${Object.keys(sheetRatMap).length} players`);
  }catch(e){console.warn('Sheet RAT:',e.message)}
}

// ===================== CLUTCH RAT ‚Äî from Clutch Stats sheet =====================
async function fetchClutchRat(){
  clutchRatMap={};
  try{
    const res=await fetch(sheetCSV(GID_CLUTCH_RAT));
    if(!res.ok)return;
    const rows=parseCSV(await res.text());
    for(const r of rows){
      const pid=parseInt(r._raw[COL_PLAYER_ID]);if(!pid)continue;
      const rat=parseFloat(r._raw[COL_CLUTCH_RAT]);
      if(!isNaN(rat))clutchRatMap[pid]=rat;
    }
    console.log(`Clutch RAT: ${Object.keys(clutchRatMap).length} players`);
  }catch(e){console.warn('Clutch RAT:',e.message)}
}

// ===================== NAME MAP ‚Äî NBA NAME ‚Üí HH NAME =====================
async function fetchNameMap(){
  nameMap={};
  try{
    const res=await fetch(sheetCSV(GID_NAMES));
    if(!res.ok)return;
    const rows=parseCSV(await res.text());
    for(const r of rows){
      const nba=(r._raw[COL_NBA_NAME]||'').trim();
      const hh=(r._raw[COL_HH_NAME]||'').trim();
      if(nba&&hh)nameMap[nba]=hh;
    }
    console.log(`Name map: ${Object.keys(nameMap).length} players`);
  }catch(e){console.warn('Name map:',e.message)}
}

// ===================== CLUTCH STATS ‚Äî CDN play-by-play =====================
async function fetchAllClutch(gameIds){
  clutchMap={};clutchStatus='loading';updateModeBadges();
  let anySuccess=false;
  for(const gid of gameIds){
    try{
      const url=`https://cdn.nba.com/static/json/liveData/playbyplay/playbyplay_${gid}.json`;
      const res=await fetch(proxied(url));
      if(!res.ok)continue;
      const data=await res.json();
      const actions=data?.game?.actions||[];
      parseClutchActions(actions);
      anySuccess=true;
    }catch(e){console.warn('PBP fetch failed for',gid,e)}
  }
  clutchStatus=anySuccess?'ok':'fail';updateModeBadges();
}

function parseClutchActions(actions){
  // Clutch = period >= 4, clock <= 5:00, score within 5
  let prevScoreH=0,prevScoreA=0;
  for(const a of actions){
    const period=a.period||0;
    if(period<4)continue;
    const clock=parseMin(a.clock||'');
    if(clock>5.0)continue;
    // Use score from action (post-action) ‚Äî check diff
    const sH=parseInt(a.scoreHome)||0, sA=parseInt(a.scoreAway)||0;
    // Use previous score for "at time of action" check
    const diff=Math.abs(prevScoreH-prevScoreA);
    prevScoreH=sH;prevScoreA=sA;
    if(diff>5)continue;

    const pid=a.personId;if(!pid)continue;
    if(!clutchMap[pid])clutchMap[pid]={pts:0,fgm:0,fga:0,fg3m:0,fg3a:0,ftm:0,fta:0,reb:0,ast:0,tov:0,stl:0,blk:0};
    const c=clutchMap[pid];
    const type=a.actionType,result=a.shotResult;

    if(type==='2pt'){c.fga++;if(result==='Made'){c.fgm++;c.pts+=2}}
    else if(type==='3pt'){c.fga++;c.fg3a++;if(result==='Made'){c.fgm++;c.fg3m++;c.pts+=3}}
    else if(type==='freethrow'){c.fta++;if(result==='Made'){c.ftm++;c.pts+=1}}
    else if(type==='rebound'&&a.subType!=='team')c.reb++;
    else if(type==='turnover')c.tov++;
    else if(type==='steal')c.stl++;
    else if(type==='block')c.blk++;

    // Assists on made FGs
    if((type==='2pt'||type==='3pt')&&result==='Made'&&a.assistPersonId){
      const apid=a.assistPersonId;
      if(!clutchMap[apid])clutchMap[apid]={pts:0,fgm:0,fga:0,fg3m:0,fg3a:0,ftm:0,fta:0,reb:0,ast:0,tov:0,stl:0,blk:0};
      clutchMap[apid].ast++;
    }
  }
}

// ===================== SCHEDULE / BOX SCORE FETCH =====================
async function fetchSchedule(){
  if(scheduleCache)return scheduleCache;
  progress('Loading NBA schedule...',5);
  for(const url of['https://cdn.nba.com/static/json/staticData/scheduleLeagueV2.json','https://cdn.nba.com/static/json/staticData/scheduleLeagueV2_1.json']){
    try{const res=await fetch(proxied(url));if(!res.ok)continue;const data=await res.json();if(data.leagueSchedule?.gameDates){scheduleCache=data;return data}}catch(e){}
  }
  throw new Error('Could not load NBA schedule. The CORS proxy may be unavailable.');
}

function findGames(schedule,dateStr){
  const[y,m,d]=dateStr.split('-');
  const targets=[`${+m}/${+d}/${y}`,`${m}/${d}/${y}`,`${+m}/${+d}/${y} 12:00:00 AM`];
  for(const gd of schedule.leagueSchedule.gameDates){
    const gdDate=gd.gameDate.split(' ')[0];
    if(targets.includes(gdDate)||targets.includes(gd.gameDate))return gd.games||[];
  }
  const allG=[];const next=new Date(dateStr+'T12:00:00');next.setDate(next.getDate()+1);const ns=next.toISOString().slice(0,10);
  for(const gd of schedule.leagueSchedule.gameDates)for(const g of(gd.games||[])){const gDate=(g.gameDateTimeUTC||'').slice(0,10);if(gDate===dateStr||gDate===ns)allG.push(g)}
  return allG;
}

async function fetchBoxScore(gid){const res=await fetch(proxied(`https://cdn.nba.com/static/json/liveData/boxscore/boxscore_${gid}.json`));if(!res.ok)throw new Error(res.status);return await res.json()}

// ===================== MAIN FETCH =====================
async function fetchDay(){
  const dateStr=document.getElementById('datePicker').value;if(!dateStr)return;
  const btn=document.getElementById('fetchBtn');
  btn.disabled=true;btn.innerHTML='<span class="spinner"></span>Loading...';
  document.getElementById('errorArea').innerHTML='';
  hustleStatus='none';clutchStatus='none';miscStatus='none';hustleMap={};clutchMap={};miscMap={};hustleDate='';miscDate='';sheetRatMap={};clutchRatMap={};updateModeBadges();

  try{
    const schedule=await fetchSchedule();
    progress('Finding games...',15);
    const games=findGames(schedule,dateStr);
    const played=games.filter(g=>(g.gameStatus||0)>=2);

    if(!played.length){
      hideProgress();document.getElementById('summaryArea').innerHTML='';document.getElementById('gamesArea').innerHTML='';
      document.getElementById('rankingsArea').innerHTML=`<div class="empty-state"><div class="icon">${games.length?'‚è∞':'üìÖ'}</div><h3>${games.length?games.length+' game(s) not started yet':'No games found'}</h3><p>${fmtDate(dateStr)}</p></div>`;
      return;
    }

    // Fetch box scores
    currentBoxScores=[];allPlayers=[];
    const gameIds=[];
    for(let i=0;i<played.length;i++){
      const g=played[i];
      const hTri=g.homeTeam?.teamTricode||'???',aTri=g.awayTeam?.teamTricode||'???';
      progress(`Fetching ${aTri} @ ${hTri} (${i+1}/${played.length})`,20+50*(i/played.length));
      try{
        const box=await fetchBoxScore(g.gameId);
        currentBoxScores.push(box);gameIds.push(g.gameId);
        const gm=box.game;
        const h=gm.homeTeam?.teamTricode||ID_TO_TRI[gm.homeTeam?.teamId]||hTri;
        const a=gm.awayTeam?.teamTricode||ID_TO_TRI[gm.awayTeam?.teamId]||aTri;
        for(const p of(gm.homeTeam?.players||[])){const s=computeStats(p,h,a,gm.gameId);if(s)allPlayers.push(s)}
        for(const p of(gm.awayTeam?.players||[])){const s=computeStats(p,a,h,gm.gameId);if(s)allPlayers.push(s)}
      }catch(e){console.warn('Box score fail:',g.gameId,e)}
    }

    // Compute advanced stats
    progress('Computing advanced stats...',75);
    computeAdvanced(allPlayers);

    // Sort by RAT
    sortCol='rat';sortDir='desc';viewMode='standard';
    allPlayers.sort((a,b)=>b.rat-a.rat);
    renderSummary(dateStr);renderGames(dateStr);renderRankings();
    hideProgress();

    // Fire off sheet data in parallel (non-blocking)
    progress('Fetching sheet data...',85);
    await Promise.allSettled([
      fetchAllHustle(),fetchAllClutch(gameIds),fetchAllMisc(),
      fetchSheetRat(),fetchClutchRat(),fetchNameMap()
    ]);

    // Apply name map (HH NAME) and sheet RAT overrides
    for(const p of allPlayers){
      if(nameMap[p.name])p.name=nameMap[p.name];
      if(sheetRatMap[p.personId]!=null)p.rat=sheetRatMap[p.personId];
    }
    allPlayers.sort((a,b)=>b.rat-a.rat);

    hideProgress();
    renderSummary(dateStr);renderRankings();

  }catch(err){
    hideProgress();
    document.getElementById('errorArea').innerHTML=`<div class="error-banner"><div class="inner">‚ö†Ô∏è ${err.message}</div></div>`;
  }finally{btn.disabled=false;btn.textContent='Fetch Games'}
}

// ===================== MODE BADGE UPDATE =====================
function updateModeBadges(){
  const hb=document.getElementById('hustleBadge');
  const cb=document.getElementById('clutchBadge');
  const mb=document.getElementById('miscBadge');
  if(hb)hb.className='badge '+(hustleStatus==='ok'?'ok':hustleStatus==='fail'?'fail':hustleStatus==='loading'?'loading':'');
  if(cb)cb.className='badge '+(clutchStatus==='ok'?'ok':clutchStatus==='fail'?'fail':clutchStatus==='loading'?'loading':'');
  if(mb)mb.className='badge '+(miscStatus==='ok'?'ok':miscStatus==='fail'?'fail':miscStatus==='loading'?'loading':'');
}

// ===================== RENDER =====================
function renderSummary(dateStr){
  const nG=currentBoxScores.length,nP=allPlayers.length;
  const top=allPlayers[0],topS=[...allPlayers].sort((a,b)=>b.pts-a.pts)[0];
  let h=`<div class="summary-bar">`;
  h+=`<div class="stat-card"><div class="label">Date</div><div class="value">${new Date(dateStr+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div><div class="sub">${fmtDate(dateStr).split(',')[0]}</div></div>`;
  h+=`<div class="stat-card"><div class="label">Games</div><div class="value">${nG}</div><div class="sub">${nP} players</div></div>`;
  if(top)h+=`<div class="stat-card"><div class="label">Player of the Day</div><div class="value" style="font-size:1.1rem">${top.name}</div><div class="sub">${top.rat} RAT ¬∑ ${top.pts}p/${top.reb}r/${top.ast}a</div></div>`;
  if(topS&&topS!==top)h+=`<div class="stat-card"><div class="label">High Scorer</div><div class="value" style="font-size:1.1rem">${topS.name}</div><div class="sub">${topS.pts} PTS ¬∑ ${(topS.ts*100).toFixed(1)}% TS</div></div>`;
  h+=`</div>`;document.getElementById('summaryArea').innerHTML=h;
}

function renderGames(dateStr){
  let h=`<div class="games-section"><h2>Games ‚Äî ${fmtDate(dateStr)}</h2><div class="games-grid">`;
  for(const box of currentBoxScores){
    const gm=box.game,hTri=gm.homeTeam?.teamTricode||'???',aTri=gm.awayTeam?.teamTricode||'???';
    const hs=gm.homeTeam?.score??0,as=gm.awayTeam?.score??0,hw=hs>as;
    const st=gm.gameStatus,stT=gm.gameStatusText||'Final',stC=st===2?'live':st>=3?'final':'upcoming';
    h+=`<div class="game-card" onclick="openBox('${gm.gameId}')"><span class="status-badge ${stC}">${stT}</span>`;
    h+=`<div class="team-row"><img src="${teamLogo(aTri)}" onerror="this.style.display='none'"><span class="team-name">${TEAM_NAMES[aTri]||aTri}</span><span class="score ${!hw&&hs!==as?'winner':''}">${as}</span></div><hr class="vs-divider">`;
    h+=`<div class="team-row"><img src="${teamLogo(hTri)}" onerror="this.style.display='none'"><span class="team-name">${TEAM_NAMES[hTri]||hTri}</span><span class="score ${hw?'winner':''}">${hs}</span></div></div>`;
  }
  h+=`</div></div>`;document.getElementById('gamesArea').innerHTML=h;
}

// ===================== COLUMN DEFINITIONS =====================
const COLS={
  standard:[
    {k:'rank',l:'#'},{k:'name',l:'Player'},{k:'min',l:'Min'},{k:'pts',l:'Pts'},{k:'reb',l:'Reb'},{k:'ast',l:'Ast'},
    {k:'stl',l:'Stl'},{k:'blk',l:'Blk'},{k:'tov',l:'TO'},{k:'pm',l:'+/‚àí'},
    {k:'fgPct',l:'FG%'},{k:'fg3Pct',l:'3P%'},{k:'ftPct',l:'FT%'},{k:'ts',l:'TS%'},
    {k:'gmScr',l:'GmScr'},{k:'rat',l:'RAT'}
  ],
  advanced:[
    {k:'rank',l:'#'},{k:'name',l:'Player'},{k:'min',l:'Min'},{k:'pts',l:'Pts'},
    {k:'efg',l:'eFG%'},{k:'ts',l:'TS%'},{k:'usg',l:'USG%'},{k:'astPct',l:'AST%'},{k:'tovPct',l:'TOV%'},
    {k:'orbPct',l:'ORB%'},{k:'drbPct',l:'DRB%'},{k:'gmScr',l:'GmScr'},{k:'rat',l:'RAT'}
  ],
  hustle:[
    {k:'rank',l:'#'},{k:'name',l:'Player'},{k:'min',l:'Min'},
    {k:'h_defl',l:'Defl'},{k:'h_loose',l:'Loose'},{k:'h_cont2',l:'Cont 2P'},{k:'h_cont3',l:'Cont 3P'},
    {k:'h_charges',l:'Charges'},{k:'h_screen',l:'Scr Ast'},{k:'h_boxout',l:'Box Out'},
    {k:'rat',l:'RAT'}
  ],
  clutch:[
    {k:'rank',l:'#'},{k:'name',l:'Player'},
    {k:'c_pts',l:'C-Pts'},{k:'c_fgm',l:'C-FGM'},{k:'c_fga',l:'C-FGA'},
    {k:'c_fg3m',l:'C-3PM'},{k:'c_fg3a',l:'C-3PA'},{k:'c_ftm',l:'C-FTM'},{k:'c_fta',l:'C-FTA'},
    {k:'c_reb',l:'C-Reb'},{k:'c_ast',l:'C-Ast'},{k:'c_tov',l:'C-TO'},
    {k:'c_stl',l:'C-Stl'},{k:'c_blk',l:'C-Blk'},
    {k:'c_rat',l:'RAT'}
  ],
  misc:[
    {k:'rank',l:'#'},{k:'name',l:'Player'},{k:'min',l:'Min'},
    {k:'m_ptsPaint',l:'Paint Pts'},{k:'m_ptsFb',l:'FB Pts'},{k:'m_pts2nd',l:'2nd Ch'},
    {k:'m_ptsOffTov',l:'Off TOV'},
    {k:'m_oppPtsPaint',l:'Opp Paint'},{k:'m_oppPtsFb',l:'Opp FB'},{k:'m_oppPts2nd',l:'Opp 2nd'},
    {k:'m_blka',l:'BLKA'},{k:'m_pfd',l:'PFD'},
    {k:'rat',l:'RAT'}
  ]
};

// ===================== RANKINGS RENDER =====================
function setMode(mode){viewMode=mode;
  if(mode==='standard')sortCol='rat';
  else if(mode==='advanced')sortCol='rat';
  else if(mode==='hustle')sortCol='h_defl';
  else if(mode==='clutch')sortCol='c_rat';
  else if(mode==='misc')sortCol='m_ptsPaint';
  sortDir='desc';renderRankings();
}

function renderRankings(){
  if(!allPlayers.length)return;
  const cols=COLS[viewMode];

  // Build player data with hustle/clutch/misc columns merged
  let data=allPlayers.map(p=>{
    const hust=hustleMap[p.personId]||{};
    const clut=clutchMap[p.personId]||{};
    const misc=miscMap[p.personId]||{};
    return{...p,
      h_defl:hust.deflections||0,h_loose:hust.looseBalls||0,
      h_cont2:hust.contested2||0,h_cont3:hust.contested3||0,
      h_charges:hust.charges||0,h_screen:hust.screenAst||0,h_boxout:hust.boxOuts||0,
      c_pts:clut.pts||0,c_fgm:clut.fgm||0,c_fga:clut.fga||0,
      c_fg3m:clut.fg3m||0,c_fg3a:clut.fg3a||0,c_ftm:clut.ftm||0,c_fta:clut.fta||0,
      c_reb:clut.reb||0,c_ast:clut.ast||0,c_tov:clut.tov||0,c_stl:clut.stl||0,c_blk:clut.blk||0,
      c_rat:clutchRatMap[p.personId]!=null?clutchRatMap[p.personId]:0,
      m_ptsPaint:misc.ptsPaint||0,m_ptsFb:misc.ptsFb||0,m_pts2nd:misc.pts2nd||0,
      m_ptsOffTov:misc.ptsOffTov||0,
      m_oppPtsPaint:misc.oppPtsPaint||0,m_oppPtsFb:misc.oppPtsFb||0,m_oppPts2nd:misc.oppPts2nd||0,
      m_blka:misc.blka||0,m_pfd:misc.pfd||0
    };
  });

  // Filter clutch mode to players with any clutch stats
  if(viewMode==='clutch'){
    data=data.filter(p=>p.c_pts||p.c_fga||p.c_reb||p.c_ast||p.c_tov||p.c_stl||p.c_blk);
  }
  // Filter hustle mode to players with sheet data
  if(viewMode==='hustle'){
    data=data.filter(p=>hustleMap[p.personId]);
  }
  // Filter misc mode to players with sheet data
  if(viewMode==='misc'){
    data=data.filter(p=>miscMap[p.personId]);
  }

  data.sort((a,b)=>{let va=a[sortCol],vb=b[sortCol];if(typeof va==='string')return sortDir==='asc'?va.localeCompare(vb):vb.localeCompare(va);return sortDir==='asc'?va-vb:vb-va});

  let h=`<div class="rankings-section"><div class="rankings-header"><h2>Player Rankings</h2>`;
  // Mode tabs
  h+=`<div class="mode-tabs">`;
  h+=`<button class="mode-tab ${viewMode==='standard'?'active':''}" onclick="setMode('standard')">Standard</button>`;
  h+=`<button class="mode-tab ${viewMode==='advanced'?'active':''}" onclick="setMode('advanced')">Advanced</button>`;
  h+=`<button class="mode-tab ${viewMode==='hustle'?'active':''}" onclick="setMode('hustle')">Hustle<span class="badge${hustleStatus==='ok'?' ok':hustleStatus==='fail'?' fail':hustleStatus==='loading'?' loading':''}" id="hustleBadge"></span></button>`;
  h+=`<button class="mode-tab ${viewMode==='clutch'?'active':''}" onclick="setMode('clutch')">Clutch<span class="badge${clutchStatus==='ok'?' ok':clutchStatus==='fail'?' fail':clutchStatus==='loading'?' loading':''}" id="clutchBadge"></span></button>`;
  h+=`<button class="mode-tab ${viewMode==='misc'?'active':''}" onclick="setMode('misc')">Misc<span class="badge${miscStatus==='ok'?' ok':miscStatus==='fail'?' fail':miscStatus==='loading'?' loading':''}" id="miscBadge"></span></button>`;
  h+=`</div>`;
  // Filters
  h+=`<div class="rankings-filters"><input type="text" placeholder="Search player..." oninput="filterName(this.value)">`;
  h+=`<select onchange="filterTeam(this.value)"><option value="">All Teams</option>`;
  const teams=[...new Set(allPlayers.map(p=>p.team))].sort();for(const t of teams)h+=`<option value="${t}">${t}</option>`;
  h+=`</select><select onchange="filterMin(this.value)"><option value="0">All Minutes</option><option value="10">10+ MIN</option><option value="20">20+ MIN</option><option value="25">25+ MIN</option></select></div></div>`;

  // Check availability
  if(viewMode==='hustle'&&hustleStatus==='fail'){
    h+=`<div class="unavailable-msg"><span>Hustle stats unavailable</span> ‚Äî data not yet loaded in the Google Sheet for this date.</div>`;
  }
  if(viewMode==='hustle'&&hustleStatus==='ok'&&hustleDate){
    h+=`<div class="sheet-date-note">Sheet data from: ${hustleDate}</div>`;
  }
  if(viewMode==='clutch'&&clutchStatus==='fail'){
    h+=`<div class="unavailable-msg"><span>Clutch stats unavailable</span> ‚Äî play-by-play data could not be loaded.</div>`;
  }
  if(viewMode==='misc'&&miscStatus==='fail'){
    h+=`<div class="unavailable-msg"><span>Misc stats unavailable</span> ‚Äî data not yet loaded in the Google Sheet for this date.</div>`;
  }
  if(viewMode==='misc'&&miscStatus==='ok'&&miscDate){
    h+=`<div class="sheet-date-note">Sheet data from: ${miscDate}</div>`;
  }
  if((viewMode==='hustle'&&hustleStatus==='loading')||(viewMode==='clutch'&&clutchStatus==='loading')||(viewMode==='misc'&&miscStatus==='loading')){
    h+=`<div class="unavailable-msg"><span class="spinner"></span> Loading ${viewMode} data...</div>`;
  }

  h+=`<div class="table-wrap"><table><thead><tr>`;
  for(const c of cols){const ar=sortCol===c.k?(sortDir==='desc'?'‚ñº':'‚ñ≤'):'';const sc=sortCol===c.k?' sorted':'';h+=`<th class="${sc}" onclick="doSort('${c.k}')">${c.l}${ar?`<span class="arrow">${ar}</span>`:''}</th>`}
  h+=`</tr></thead><tbody id="rankingsBody">`;
  for(let i=0;i<data.length;i++)h+=buildRow(data[i],i+1,cols);
  h+=`</tbody></table></div></div>`;
  document.getElementById('rankingsArea').innerHTML=h;
}

function buildRow(p,rank,cols){
  const badge=rank===1?'<span class="top-badge gold">‚òÖ POTD</span>':rank===2?'<span class="top-badge silver">2ND</span>':rank===3?'<span class="top-badge bronze">3RD</span>':'';
  let t=`<tr data-name="${(p.name||'').toLowerCase()}" data-team="${p.team}" data-min="${p.min}">`;
  for(const c of cols){
    if(c.k==='rank'){t+=`<td class="rank-cell">${rank}</td>`;continue}
    if(c.k==='name'){t+=`<td class="player-cell"><img src="${headshot(p.personId)}" onerror="this.style.display='none'" loading="lazy"><span class="pname">${p.name}${badge}</span><span class="pteam">${p.team}</span></td>`;continue}
    const v=p[c.k];
    // Format based on key
    if(c.k==='rat'||c.k==='c_rat'){t+=`<td class="rat-cell" style="color:${v>=30?'var(--accent-gold)':v>=20?'var(--accent-cyan)':'inherit'}">${v.toFixed(1)}</td>`;continue}
    if(c.k==='pm'){t+=`<td class="num ${v>0?'positive':v<0?'negative':''}">${v>0?'+':''}${v}</td>`;continue}
    if(c.k==='pts'){t+=`<td class="num" style="font-weight:700">${v}</td>`;continue}
    if(c.k==='gmScr'){t+=`<td class="num">${v.toFixed(1)}</td>`;continue}
    // Percentages
    if(['fgPct','fg3Pct','ftPct','ts','efg'].includes(c.k)){
      const pctVal=v*100;
      let color='inherit';
      if(c.k==='ts'){color=v>=0.6?'var(--positive)':v<0.45?'var(--negative)':'inherit'}
      if(c.k==='efg'){color=v>=0.55?'var(--positive)':v<0.42?'var(--negative)':'inherit'}
      t+=`<td class="num" style="color:${color}">${pctVal.toFixed(c.k==='ts'||c.k==='efg'?1:0)}%</td>`;continue;
    }
    // Advanced % (already multiplied by 10 in compute)
    if(['usg','astPct','tovPct','orbPct','drbPct'].includes(c.k)){
      let color='inherit';
      if(c.k==='usg')color=v>=30?'var(--accent-gold)':v>=25?'var(--accent-cyan)':'inherit';
      t+=`<td class="num" style="color:${color}">${v.toFixed(1)}%</td>`;continue;
    }
    // Hustle/Clutch/Misc ‚Äî plain numbers
    if(c.k.startsWith('h_')||c.k.startsWith('c_')||c.k.startsWith('m_')){
      const isKey=c.k==='c_pts'||c.k==='h_defl'||c.k==='m_ptsPaint';
      t+=`<td class="num"${isKey?' style="font-weight:700"':''}>${v}</td>`;continue;
    }
    // Default numeric
    t+=`<td class="num">${typeof v==='number'?Math.round(v):v}</td>`;
  }
  t+=`</tr>`;return t;
}

// ===================== SORT & FILTER =====================
function doSort(col){if(col==='rank')return;if(sortCol===col)sortDir=sortDir==='desc'?'asc':'desc';else{sortCol=col;sortDir=col==='name'?'asc':'desc'}renderRankings()}
function filterName(q){q=q.toLowerCase();document.querySelectorAll('#rankingsBody tr').forEach(tr=>{tr.style.display=tr.dataset.name.includes(q)?'':'none'})}
function filterTeam(t){document.querySelectorAll('#rankingsBody tr').forEach(tr=>{tr.style.display=(!t||tr.dataset.team===t)?'':'none'})}
function filterMin(m){m=parseFloat(m);document.querySelectorAll('#rankingsBody tr').forEach(tr=>{tr.style.display=parseFloat(tr.dataset.min)>=m?'':'none'})}

// ===================== BOX SCORE MODAL =====================
function openBox(gameId){
  const box=currentBoxScores.find(b=>b.game?.gameId===gameId);if(!box)return;
  const gm=box.game,hTri=gm.homeTeam?.teamTricode||'???',aTri=gm.awayTeam?.teamTricode||'???';
  document.getElementById('boxTitle').textContent=`${TEAM_NAMES[aTri]||aTri} ${gm.awayTeam?.score??0} ‚Äî ${TEAM_NAMES[hTri]||hTri} ${gm.homeTeam?.score??0}`;
  let h='';
  for(const side of['awayTeam','homeTeam']){
    const team=gm[side];if(!team)continue;
    const tri=team.teamTricode||'???';
    const players=(team.players||[]).map(p=>({raw:p,stats:computeStats(p,tri,side==='homeTeam'?aTri:hTri,gameId)})).sort((a,b)=>(b.stats?.min||0)-(a.stats?.min||0));
    h+=`<div class="box-team-label"><img src="${teamLogo(tri)}" onerror="this.style.display='none'"> ${TEAM_NAMES[tri]||tri} (${team.score??0})</div>`;
    h+=`<div class="table-wrap"><table><thead><tr><th>Player</th><th>Min</th><th>Pts</th><th>FGM-A</th><th>3PM-A</th><th>FTM-A</th><th>ORB</th><th>DRB</th><th>REB</th><th>AST</th><th>STL</th><th>BLK</th><th>TO</th><th>PF</th><th>+/‚àí</th><th>TS%</th><th>GmScr</th><th>RAT</th></tr></thead><tbody>`;
    let tot={pts:0,fgm:0,fga:0,fg3m:0,fg3a:0,ftm:0,fta:0,orb:0,drb:0,reb:0,ast:0,stl:0,blk:0,tov:0,pf:0};
    for(const{raw:rp,stats:s}of players){
      const nm=rp.name||`${rp.firstName||''} ${rp.familyName||''}`.trim();
      if(!s){h+=`<tr class="dnp"><td style="font-weight:500">${nm}</td><td colspan="17" style="color:var(--text-muted);font-size:0.75rem">DNP</td></tr>`;continue}
      Object.keys(tot).forEach(k=>{if(s[k]!==undefined)tot[k]+=s[k]});
      h+=`<tr><td style="font-weight:500;min-width:130px">${nm}</td><td class="num">${s.min.toFixed(0)}</td><td class="num" style="font-weight:700">${s.pts}</td>`;
      h+=`<td class="num">${s.fgm}-${s.fga}</td><td class="num">${s.fg3m}-${s.fg3a}</td><td class="num">${s.ftm}-${s.fta}</td>`;
      h+=`<td class="num">${s.orb}</td><td class="num">${s.drb}</td><td class="num">${s.reb}</td><td class="num">${s.ast}</td><td class="num">${s.stl}</td><td class="num">${s.blk}</td><td class="num">${s.tov}</td><td class="num">${s.pf}</td>`;
      h+=`<td class="num ${s.pm>0?'positive':s.pm<0?'negative':''}">${s.pm>0?'+':''}${s.pm}</td>`;
      h+=`<td class="num">${(s.ts*100).toFixed(1)}%</td><td class="num">${s.gmScr.toFixed(1)}</td>`;
      h+=`<td class="num" style="font-weight:700;color:${s.rat>=30?'var(--accent-gold)':s.rat>=20?'var(--accent-cyan)':'inherit'}">${s.rat.toFixed(1)}</td></tr>`;
    }
    const tt=tot;
    h+=`<tr class="team-totals"><td>TOTALS</td><td></td><td class="num">${tt.pts}</td><td class="num">${tt.fgm}-${tt.fga}</td><td class="num">${tt.fg3m}-${tt.fg3a}</td><td class="num">${tt.ftm}-${tt.fta}</td>`;
    h+=`<td class="num">${tt.orb}</td><td class="num">${tt.drb}</td><td class="num">${tt.reb}</td><td class="num">${tt.ast}</td><td class="num">${tt.stl}</td><td class="num">${tt.blk}</td><td class="num">${tt.tov}</td><td class="num">${tt.pf}</td><td></td><td></td><td></td><td></td></tr>`;
    h+=`</tbody></table></div>`;
  }
  document.getElementById('boxContent').innerHTML=h;
  document.getElementById('boxOverlay').classList.add('open');document.body.style.overflow='hidden';
}
function closeBox(){document.getElementById('boxOverlay').classList.remove('open');document.body.style.overflow=''}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeBox()});

// ===================== INIT =====================
document.getElementById('datePicker').value=todayPacific();
</script>
</body>
</html>
